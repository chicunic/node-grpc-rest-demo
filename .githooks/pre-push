#!/bin/bash

# Pre-push hook
# This hook runs before pushing to remote repository

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the remote and branch being pushed to
remote="$1"
url="$2"

# Read the branch being pushed
while read local_ref local_sha remote_ref remote_sha
do
    # Extract branch name
    branch=$(echo "$remote_ref" | sed 's/refs\/heads\///')

    echo -e "${BLUE}üöÄ Pre-push checks for branch: ${branch}${NC}"

    # Code quality check
    echo -e "${YELLOW}üîç Running code quality checks...${NC}"
    if ! pnpm run check; then
        echo -e "${RED}‚ùå Code quality checks failed!${NC}"
        echo -e "${YELLOW}üí° Run 'pnpm run fix' to auto-fix formatting and linting issues${NC}"
        exit 1
    fi

    # Security check
    sensitive_file=$(git diff HEAD origin/$branch --name-only | grep -v "^\.githooks/" | xargs grep -lE "(gcp-.*-[0-9]|api[_-]?key|secret[_-]?key|access[_-]?token|bearer[_-]?token|jwt[_-]?token|password\s*=|mongodb://.*:[^@]*@|mysql://.*:[^@]*@|postgres://.*:[^@]*@|AKIA[0-9A-Z]{16}|sk-[a-zA-Z0-9]{32,}|xoxb-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}|-----BEGIN.*PRIVATE KEY-----|client_secret|webhook_secret|encryption_key)" 2>/dev/null | head -1)
    if [ ! -z "$sensitive_file" ]; then
        echo -e "${RED}‚ùå Sensitive information detected in: ${sensitive_file}${NC}"
        echo -e "${YELLOW}Please remove any secrets, API keys, or credentials before pushing${NC}"
        exit 1
    fi

    # Special checks for production and staging branches
    if [[ "$branch" == "production" ]] || [[ "$branch" == "staging" ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Pushing to ${branch} branch - Running comprehensive checks${NC}"

        # Build check
        echo -e "${YELLOW}üèóÔ∏è  Building project...${NC}"
        if ! pnpm run build; then
            echo -e "${RED}‚ùå Build failed!${NC}"
            exit 1
        fi

        # Run all tests
        echo -e "${YELLOW}üß™ Running tests...${NC}"
        if ! pnpm test; then
            echo -e "${RED}‚ùå Tests failed!${NC}"
            exit 1
        fi

        # Confirmation for production
        if [[ "$branch" == "production" ]]; then
            echo -e "${YELLOW}‚ö†Ô∏è  You are pushing to PRODUCTION branch${NC}"
            echo -e "${YELLOW}This will trigger automatic deployment to production environment${NC}"
            read -p "Are you absolutely sure? (y/n): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo -e "${RED}‚ùå Push cancelled${NC}"
                exit 1
            fi
        fi
    fi
done

echo -e "${GREEN}‚úÖ All pre-push checks passed!${NC}"
echo -e "${GREEN}üöÄ Pushing to ${remote}...${NC}"
